{% extends 'layout.html' %} {% block content %}
<h1>{{title}}</h1>
<!-- 상단 우측에 참여자 수/목록 -->
<div class="room-meta">
  <div class="room-meta__right">
    <span class="pill"> 참여자 <span id="member-count">0</span>명 </span>
    <button id="toggle-members" type="button" class="ghost">목록</button>
  </div>
</div>

<!-- 클릭 시 토글되는 참여자 목록 -->
<ul id="member-list" class="member-list hidden"></ul>

<a href="/" id="exit-btn">방 나가기</a>
<fieldset>
  <legend>채팅 내용</legend>
  <div id="chat-list">
    {% for chat in chats %} {% if chat.user === user %}
    <div class="mine" style="color: {{chat.user}}">
      <div>{{chat.user}}</div>
      {% if chat.gif %}}
      <img src="/gif/{{chat.gif}}" />
      {% else %}
      <div>{{chat.chat}}</div>
      {% endif %}
    </div>
    {% elif chat.user === 'system' %}
    <div class="system">
      <div>{{chat.chat}}</div>
    </div>
    {% else %}
    <div class="other" style="color: {{chat.user}}">
      <div>{{chat.user}}</div>
      {% if chat.gif %}
      <img src="/gif/{{chat.gif}}" />
      {% else %}
      <div>{{chat.chat}}</div>
      {% endif %}
    </div>
    {% endif %} {% endfor %}
  </div>
</fieldset>
<form action="/chat" id="chat-form" method="post" enctype="multipart/form-data">
  <label for="gif">GIF 올리기</label>
  <input type="file" id="gif" name="gif" accept="image/gif" />
  <input type="text" id="chat" name="chat" />
  <button type="submit">전송</button>
</form>

<!-- 선택한 귓속말 대상 표시 -->
<div
  id="whisper-target"
  style="margin: 6px 0; font-size: 12px; color: #6b7280"
></div>

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
  const ROOM_ID = "{{room.id}}";
  const socket = io.connect("http://localhost:8005/chat", {
    path: "/socket.io",
  });

  let WHISPER_TO = null; // 선택된 귓속말 대상 socketId
  let WHISPER_TO_LABEL = null; // 대상 표시용 라벨(참여자 목록 label)

  // 참여자 렌더 헬퍼
  function renderParticipants(payload) {
    if (!payload) return;
    const { count, members } = payload;

    document.getElementById("member-count").textContent = String(count);

    const listEl = document.getElementById("member-list");
    listEl.innerHTML = "";
    members.forEach((m) => {
      const li = document.createElement("li");
      li.textContent = m.label || m.socketId?.slice(0, 5) || "알 수 없음";
      li.dataset.sid = m.socketId;

      // 클릭하면 귓속말 대상 설정
      li.style.cursor = "pointer";
      li.addEventListener("click", () => {
        WHISPER_TO = m.socketId;
        WHISPER_TO_LABEL = m.label || m.socketId?.slice(0, 5);
        const box = document.getElementById("whisper-target");
        box.innerHTML = `귓속말 대상: <b>${WHISPER_TO_LABEL}</b> 
          <button id="clear-whisper" type="button" style="margin-left:6px;">취소</button>`;
        // 취소
        document.getElementById("clear-whisper").onclick = () => {
          WHISPER_TO = null;
          WHISPER_TO_LABEL = null;
          box.textContent = "";
        };
      });

      listEl.appendChild(li);
    });
  }

  // 소켓 연결 완료 후 1회: 입장 시스템 메시지 저장 + 브로드캐스트
  socket.on("connect", () => {
    axios.post(`/room/${ROOM_ID}/system/join`).catch(console.error);
  });

  // 목록 토글 버튼
  document.getElementById("toggle-members")?.addEventListener("click", () => {
    const listEl = document.getElementById("member-list");
    if (!listEl) return;
    listEl.classList.toggle("hidden");
  });

  socket.on("join", function (data) {
    const div = document.createElement("div");
    div.classList.add("system");
    const chat = document.createElement("div");
    div.textContent = data.chat;
    div.appendChild(chat);
    document.querySelector("#chat-list").appendChild(div);

    // join payload에 participants가 함께 오면 즉시 반영
    if (data.participants) renderParticipants(data.participants);
  });

  socket.on("exit", function (data) {
    const div = document.createElement("div");
    div.classList.add("system");
    const chat = document.createElement("div");
    div.textContent = data.chat;
    div.appendChild(chat);
    document.querySelector("#chat-list").appendChild(div);

    // exit payload에 participants가 함께 오면 즉시 반영
    if (data.participants) renderParticipants(data.participants);
  });

  // 채팅 메시지
  socket.on("chat", function (data) {
    const div = document.createElement("div");
    if (data.user === "{{user}}") {
      div.classList.add("mine");
    } else {
      div.classList.add("other");
    }
    const name = document.createElement("div");
    name.textContent = data.user;
    div.appendChild(name);
    if (data.chat) {
      const chat = document.createElement("div");
      chat.textContent = data.chat;
      div.appendChild(chat);
    } else {
      const gif = document.createElement("img");
      gif.src = "/gif/" + data.gif;
      div.appendChild(gif);
    }
    div.style.color = data.user;
    document.querySelector("#chat-list").appendChild(div);
  });

  // 귓속말 수신/에코
  socket.on("whisper", function (data) {
    const div = document.createElement("div");

    // 내 메시지/상대 메시지 구분
    if (data.fromSocketId === socket.id) {
      div.classList.add("mine", "whisper");
    } else {
      div.classList.add("other", "whisper");
    }

    const name = document.createElement("div");
    name.textContent = `${data.user} (귓속말)`;
    div.appendChild(name);

    const chat = document.createElement("div");
    chat.textContent = data.chat;
    div.appendChild(chat);

    div.style.color = data.user; // 기존 color 라벨 유지
    document.querySelector("#chat-list").appendChild(div);
  });

  // 에러 안내(상대 없음 등)
  socket.on("whisper:error", ({ message }) => {
    const div = document.createElement("div");
    div.classList.add("system");
    div.textContent = message || "귓속말을 보낼 수 없습니다.";
    document.querySelector("#chat-list").appendChild(div);
  });

  // 참여자 목록 브로드캐스트 수신 (서버에서 room:participants 쏨)
  socket.on("room:participants", (payload) => {
    renderParticipants(payload);
  });

  // ✅ 귓속말 수신/에코
  socket.on("whisper", (data) => {
    const div = document.createElement("div");
    div.classList.add(
      data.fromSocketId === socket.id ? "mine" : "other",
      "whisper"
    );
    const name = document.createElement("div");
    name.textContent = `${data.user} (귓속말)`;
    const chat = document.createElement("div");
    chat.textContent = data.chat;
    div.appendChild(name);
    div.appendChild(chat);
    div.style.color = data.user;
    document.querySelector("#chat-list").appendChild(div);
  });

  // 에러
  socket.on("whisper:error", ({ message }) => {
    const div = document.createElement("div");
    div.classList.add("system");
    div.textContent = message || "귓속말을 보낼 수 없습니다.";
    document.querySelector("#chat-list").appendChild(div);
  });

  // 새로고침 직후에도 목록을 보장하고 싶으면 1회 요청
  // 서버 socket.js에서 socket.on("who") 핸들러를 이미 넣어둠
  // 초기 목록 요청(유지)
  socket.emit("who");

  // 폼/업로드
  document.querySelector("#chat-form").addEventListener("submit", function (e) {
    e.preventDefault();
    const text = this.chat.value?.trim();
    if (!text) return;

    if (WHISPER_TO) {
      socket.emit("whisper:send", { to: WHISPER_TO, chat: text });
      this.chat.value = "";
      return;
    }

    // 일반 채팅
    axios
      .post("/room/{{ room._id }}/chat", { chat: text })
      .then(() => {
        this.chat.value = "";
      })
      .catch(console.error);
  });

  document.querySelector("#gif").addEventListener("change", function (e) {
    console.log(e.target.files);
    const formData = new FormData();
    formData.append("gif", e.target.files[0]);
    axios
      .post("/room/{{room._id}}/gif", formData)
      .then(() => {
        e.target.file = null;
      })
      .catch((err) => {
        console.error(err);
      });
  });

  // 방 나가기 버튼 클릭 시, 라우터 호출 후 메인으로 이동
  document.getElementById("exit-btn")?.addEventListener("click", async (e) => {
    e.preventDefault();
    try {
      await axios.post(`/room/${ROOM_ID}/system/exit`);
    } catch (err) {
      console.error(err);
    } finally {
      location.href = "/";
    }
  });

  // 페이지 닫기/새로고침 시에도 퇴장 시도 (응답 기다리지 않음)
  window.addEventListener("beforeunload", () => {
    const url = `/room/${ROOM_ID}/system/exit`;
    const data = new Blob([], { type: "application/json" });
    navigator.sendBeacon(url, data);
  });

  members.forEach((m) => {
    const li = document.createElement("li");
    li.textContent = m.label || m.socketId?.slice(0, 5) || "알 수 없음";
    li.dataset.sid = m.socketId;

    // 클릭하면 귓속말 대상 선택
    li.addEventListener("click", () => {
      WHISPER_TO = m.socketId;
      WHISPER_TO_LABEL = m.label || m.socketId?.slice(0, 5);
      const box = document.getElementById("whisper-target");
      if (box) {
        box.innerHTML = `귓속말 대상: <b>${WHISPER_TO_LABEL}</b> <button id="clear-whisper" type="button">취소</button>`;
        // 취소 버튼
        box.querySelector("#clear-whisper")?.addEventListener("click", () => {
          WHISPER_TO = null;
          WHISPER_TO_LABEL = null;
          box.textContent = "";
        });
      }
    });

    listEl.appendChild(li);
  });
</script>
{% endblock %}
